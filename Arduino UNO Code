#include <Wire.h>
#include <Adafruit_Sensor.h>
#include <DHT.h>
#include <MAX30100_PulseOximeter.h>
#include <BlynkSimpleEsp32.h>

// DHT Sensor configuration
#define DHTPIN 2
#define DHTTYPE DHT22
DHT dht(DHTPIN, DHTTYPE);

// Pulse Oximeter object
MAX30100_PulseOximeter pox;

// Blynk authentication and WiFi credentials
char auth[] = "YourBlynkAuthToken";
char ssid[] = "YourWiFiSSID";
char pass[] = "YourWiFiPassword";

// Variables to store sensor data
float temperature, humidity;
uint32_t heartRate;
uint32_t spo2;

void setup() {
  Serial.begin(9600);
  dht.begin();
  Blynk.begin(auth, ssid, pass);

  // Initialize MAX30100 sensor
  if (!pox.begin()) {
    Serial.println("MAX30100 not found. Please check wiring.");
    while (1);
  }

  pox.setIRLedCurrent(MAX30100_PulseOximeter::LED_CURR_50MA);
}

void loop() {
  Blynk.run();

  // Read data from sensors
  temperature = dht.readTemperature();
  humidity = dht.readHumidity();
  
  pox.update();
  heartRate = pox.getHeartRate();
  spo2 = pox.getSpO2();

  // Send data to Blynk app
  Blynk.virtualWrite(V0, temperature);
  Blynk.virtualWrite(V1, humidity);
  Blynk.virtualWrite(V2, heartRate);
  Blynk.virtualWrite(V3, spo2);

  // Print data to Serial Monitor
  Serial.print("Temperature: ");
  Serial.print(temperature);
  Serial.print(" °C\t");

  Serial.print("Humidity: ");
  Serial.print(humidity);
  Serial.print(" %\t");

  Serial.print("Heart Rate: ");
  Serial.print(heartRate);
  Serial.print(" bpm\t");

  Serial.print("SpO2: ");
  Serial.print(spo2);
  Serial.println(" %");

  // Check for abnormal values
  if (temperature > 37.5 || heartRate > 100 || spo2 < 90) {
    Serial.println("⚠ Warning: Abnormal values detected.");
  }

  delay(2000); // Wait for 2 seconds before next reading
}
